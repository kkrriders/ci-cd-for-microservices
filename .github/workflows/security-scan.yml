name: Security Scanning

on:
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM
  workflow_dispatch:     # Allow manual triggering

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Run SAST scan
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript
          
      - name: Run dependency scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          
      - name: Upload scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: Run OWASP ZAP scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: 'http://localhost:8082,http://localhost:8083'
          
      - name: Generate security report
        run: |
          echo "# Security Scan Report" > security-report.md
          echo "## Scan date: $(date)" >> security-report.md
          echo "## Summary" >> security-report.md
          
          # Add dependency scan results
          echo "### Dependency vulnerabilities" >> security-report.md
          cat trivy-results.sarif | jq -r '.runs[0].results | length' | xargs -I {} echo "Found {} issues" >> security-report.md
          
          # Add SAST scan results
          echo "### SAST vulnerabilities" >> security-report.md
          ls -la
          
          # Add ZAP scan results
          echo "### API vulnerabilities" >> security-report.md
          cat zap-scan-results.json | jq -r '.site[0].alerts | length' | xargs -I {} echo "Found {} issues" >> security-report.md
          
      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.md
          
      - name: Send notification
        if: ${{ failure() }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 